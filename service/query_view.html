<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PaperView · Query 结果可视化</title>
    <style>
      :root {
        --bg: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --card: #ffffff;
        --card2: #f8fafc;
        --border: #e2e8f0;
        --ok: #16a34a;
        --warn: #f59e0b;
        --err: #ef4444;
        --info: #2563eb;
        --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", Arial, "Noto Sans";
        background: var(--bg);
        color: var(--text);
      }

      a {
        color: var(--info);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      header {
        padding: 20px 18px 14px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--bg);
      }

      .wrap {
        max-width: 1400px;
        margin: 0 auto;
      }

      h1 {
        font-size: 20px;
        margin: 0 0 10px 0;
        font-weight: 650;
        letter-spacing: 0.2px;
      }

      .controls {
        display: grid;
        grid-template-columns: 1.4fr 0.9fr 0.6fr 0.7fr 1.1fr 0.9fr 1fr;
        gap: 10px;
        align-items: end;
      }

      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }

      input[type="text"],
      select,
      button,
      input[type="file"] {
        width: 100%;
        font-size: 13px;
        padding: 9px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--text);
        outline: none;
      }

      input[type="file"] {
        padding: 7px 10px;
      }

      button {
        cursor: pointer;
        background: #fff;
        border: 1px solid var(--border);
        font-weight: 600;
      }
      button:hover {
        border-color: #cbd5e1;
      }
      button.primary {
        background: #4f46e5;
        border-color: #4f46e5;
        color: #fff;
      }
      button.secondary {
        background: #fff;
        border: 1px solid var(--border);
        font-weight: 600;
      }

      .stats {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        padding: 6px 9px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: var(--card2);
        font-size: 12px;
        color: var(--muted);
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--muted);
      }

      main {
        padding: 16px 18px 40px;
      }

      @media (max-width: 980px) {
        .controls {
          grid-template-columns: 1fr 1fr;
        }
      }

      .list {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      details.paper {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      details.paper > summary {
        list-style: none;
        cursor: pointer;
        padding: 14px;
        display: flex;
        gap: 12px;
        align-items: flex-start;
        justify-content: space-between;
      }
      details.paper > summary::-webkit-details-marker {
        display: none;
      }
      details.paper[open] > summary {
        border-bottom: 1px dashed var(--border);
      }

      .head-left {
        min-width: 0;
        flex: 1;
      }
      .title {
        font-size: 16px;
        font-weight: 700;
        line-height: 1.35;
      }
      .meta {
        margin-top: 6px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.4;
      }

      .badges {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .badge {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
        background: #fff;
      }
      .badge.ok {
        border-color: rgba(22, 163, 74, 0.35);
        color: #166534;
        background: rgba(22, 163, 74, 0.08);
      }
      .badge.warn {
        border-color: rgba(245, 158, 11, 0.45);
        color: #92400e;
        background: rgba(245, 158, 11, 0.1);
      }
      .badge.err {
        border-color: rgba(239, 68, 68, 0.45);
        color: #991b1b;
        background: rgba(239, 68, 68, 0.08);
      }

      .paper-body {
        padding: 12px 14px 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .section {
        background: var(--card2);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
      }
      .section h3 {
        margin: 0 0 6px 0;
        font-size: 12px;
        color: #334155;
      }
      .section .paper-list {
        margin: 0;
        padding-left: 18px;
        color: var(--text);
        font-size: 13px;
        line-height: 1.5;
      }
      .response {
        white-space: pre-wrap;
        line-height: 1.6;
        font-size: 12.5px;
        overflow-wrap: anywhere;
      }
      .response.markdown {
        white-space: normal;
      }
      .md-switch {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .md-switch button {
        width: auto;
        padding: 5px 10px;
        font-size: 12px;
      }
      .md-switch button.active {
        background: #2563eb;
        border-color: #2563eb;
        color: #fff;
      }
      .md-pane.hidden {
        display: none;
      }
      .response.markdown h1,
      .response.markdown h2,
      .response.markdown h3,
      .response.markdown h4,
      .response.markdown h5,
      .response.markdown h6 {
        margin: 0.8em 0 0.45em;
        line-height: 1.35;
      }
      .response.markdown h1 {
        font-size: 1.25em;
      }
      .response.markdown h2 {
        font-size: 1.15em;
      }
      .response.markdown h3 {
        font-size: 1.08em;
      }
      .response.markdown p {
        margin: 0.45em 0;
      }
      .response.markdown ul,
      .response.markdown ol {
        margin: 0.45em 0;
        padding-left: 1.25em;
      }
      .response.markdown li {
        margin: 0.2em 0;
      }
      .response.markdown blockquote {
        margin: 0.6em 0;
        padding: 0.3em 0.8em;
        border-left: 3px solid #94a3b8;
        background: #fff;
        color: #334155;
      }
      .response.markdown pre {
        margin: 0.6em 0;
        padding: 10px;
        border-radius: 9px;
        border: 1px solid var(--border);
        background: #0f172a;
        color: #e2e8f0;
        overflow: auto;
      }
      .response.markdown code {
        background: #e2e8f0;
        border-radius: 6px;
        padding: 1px 5px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 0.93em;
      }
      .response.markdown pre code {
        background: transparent;
        padding: 0;
        color: inherit;
      }

      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .actions button {
        font-size: 12px;
        padding: 6px 10px;
      }

      details.question > summary {
        cursor: pointer;
        font-size: 12px;
        color: var(--muted);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        user-select: none;
      }
      details.question > summary::-webkit-details-marker {
        display: none;
      }
      details.question[open] > summary {
        margin-bottom: 8px;
      }
      details.question pre {
        margin: 0;
        padding: 10px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 12px;
        line-height: 1.45;
      }

      .hint {
        color: var(--muted);
        font-size: 12px;
        margin: 6px 0 0;
      }
      .history-actions {
        margin-top: 8px;
        display: flex;
        gap: 8px;
      }
      .history-actions button {
        width: auto;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap">
        <h1>PaperView · Query 结果可视化（JSONL）</h1>
        <div class="controls">
          <div>
            <label>加载结果文件（推荐：papers.query.jsonl / papers.*.jsonl）</label>
            <input id="file" type="file" accept=".jsonl,application/json,text/plain" />
          </div>
          <div>
            <label>搜索（标题 / arXiv / 回答）</label>
            <input id="q" type="text" placeholder="例如：data, diffusion, RT-2..." />
          </div>
          <div>
            <label>状态</label>
            <select id="status">
              <option value="">全部</option>
            </select>
          </div>
          <div>
            <label>排序</label>
            <select id="sort">
              <option value="tokens_desc">tokens ↓</option>
              <option value="elapsed_asc">耗时 ↑</option>
              <option value="title_asc">标题 A→Z</option>
            </select>
          </div>
          <div>
            <label>历史查询</label>
            <select id="history"></select>
            <div class="history-actions">
              <button id="refreshHistory" type="button" class="secondary">刷新历史</button>
              <button id="deleteHistory" type="button" class="secondary">删除当前</button>
              <button id="clearHistoryAll" type="button" class="secondary">清空历史</button>
            </div>
          </div>
          <div>
            <label>展开/折叠</label>
            <div style="display: flex; gap: 10px">
              <button id="expandAll" type="button" class="secondary">全部展开</button>
              <button id="collapseAll" type="button" class="secondary">全部折叠</button>
            </div>
          </div>
          <div>
            <label>快速加载</label>
            <div style="display: flex; gap: 10px">
              <button id="loadDefault" type="button">加载默认路径</button>
              <button id="clear" type="button" class="secondary">清空</button>
            </div>
          </div>
        </div>
        <div class="stats" id="stats"></div>
        <div class="hint" id="loadHint">
          优先加载当前查询（URL 参数 <code>?job=</code>），也可在「历史查询」中切换；离线查看请手动选择 papers.query.jsonl。
        </div>
      </div>
    </header>

    <main class="wrap">
      <div id="list" class="list"></div>
    </main>

    <script>
      const state = {
        all: [],
        filtered: [],
        parseErrors: 0,
        activeJobId: null,
      };

      const elFile = document.getElementById("file");
      const elQ = document.getElementById("q");
      const elStatus = document.getElementById("status");
      const elSort = document.getElementById("sort");
      const elList = document.getElementById("list");
      const elStats = document.getElementById("stats");
      const elLoadDefault = document.getElementById("loadDefault");
      const elClear = document.getElementById("clear");
      const elHistory = document.getElementById("history");
      const elRefreshHistory = document.getElementById("refreshHistory");
      const elDeleteHistory = document.getElementById("deleteHistory");
      const elClearHistoryAll = document.getElementById("clearHistoryAll");
      const elLoadHint = document.getElementById("loadHint");
      const elExpandAll = document.getElementById("expandAll");
      const elCollapseAll = document.getElementById("collapseAll");

      function safeText(v) {
        return (v ?? "").toString();
      }

      function escapeHtml(text) {
        return safeText(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function renderInlineMarkdown(text) {
        let out = escapeHtml(text);
        out = out.replace(
          /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
          '<a href="$2" target="_blank" rel="noreferrer">$1</a>'
        );
        out = out.replace(/`([^`]+)`/g, "<code>$1</code>");
        out = out.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        out = out.replace(/\*([^*]+)\*/g, "<em>$1</em>");
        out = out.replace(/~~([^~]+)~~/g, "<del>$1</del>");
        return out;
      }

      function renderMarkdown(mdText) {
        const lines = safeText(mdText).replace(/\r/g, "").split("\n");
        const html = [];
        let inCode = false;
        let codeLines = [];
        let inUl = false;
        let inOl = false;

        const closeLists = () => {
          if (inUl) {
            html.push("</ul>");
            inUl = false;
          }
          if (inOl) {
            html.push("</ol>");
            inOl = false;
          }
        };

        const flushCode = () => {
          if (!inCode) return;
          html.push(`<pre><code>${escapeHtml(codeLines.join("\n"))}</code></pre>`);
          codeLines = [];
          inCode = false;
        };

        for (const rawLine of lines) {
          const line = rawLine || "";
          const trim = line.trim();

          if (/^```/.test(trim)) {
            if (inCode) {
              flushCode();
            } else {
              closeLists();
              inCode = true;
              codeLines = [];
            }
            continue;
          }

          if (inCode) {
            codeLines.push(line);
            continue;
          }

          if (!trim) {
            closeLists();
            continue;
          }

          const heading = trim.match(/^(#{1,6})\s+(.+)$/);
          if (heading) {
            closeLists();
            const lvl = heading[1].length;
            html.push(`<h${lvl}>${renderInlineMarkdown(heading[2])}</h${lvl}>`);
            continue;
          }

          if (/^(-{3,}|\*{3,}|_{3,})$/.test(trim)) {
            closeLists();
            html.push("<hr />");
            continue;
          }

          const ulItem = line.match(/^\s*[-*+]\s+(.+)$/);
          if (ulItem) {
            if (inOl) {
              html.push("</ol>");
              inOl = false;
            }
            if (!inUl) {
              html.push("<ul>");
              inUl = true;
            }
            html.push(`<li>${renderInlineMarkdown(ulItem[1])}</li>`);
            continue;
          }

          const olItem = line.match(/^\s*\d+\.\s+(.+)$/);
          if (olItem) {
            if (inUl) {
              html.push("</ul>");
              inUl = false;
            }
            if (!inOl) {
              html.push("<ol>");
              inOl = true;
            }
            html.push(`<li>${renderInlineMarkdown(olItem[1])}</li>`);
            continue;
          }

          closeLists();

          if (/^>\s?/.test(trim)) {
            html.push(`<blockquote><p>${renderInlineMarkdown(trim.replace(/^>\s?/, ""))}</p></blockquote>`);
            continue;
          }

          html.push(`<p>${renderInlineMarkdown(trim)}</p>`);
        }

        flushCode();
        closeLists();
        return html.join("");
      }

      function setLoadHint(text) {
        if (!elLoadHint) return;
        elLoadHint.textContent = text;
      }

      function getArxivUrl(arxivId) {
        const id = safeText(arxivId).trim();
        if (!id) return "";
        return `https://arxiv.org/abs/${encodeURIComponent(id)}`;
      }

      function normalizeRecord(rec) {
        const usage = rec.query_usage || {};
        const totalTokens =
          Number(usage.total_tokens ?? rec.total_tokens ?? rec.total_tokens) || 0;
        const elapsed = Number(rec.query_elapsed_ms ?? rec.query_elapsed_ms) || 0;
        const status = safeText(rec.query_status || rec.status || "").trim();
        return {
          paper_id: safeText(rec.paper_id),
          title: safeText(rec.title),
          arxiv_id: safeText(rec.arxiv_id),
          year: rec.year,
          venue: safeText(rec.venue),
          merged_papers: Array.isArray(rec.merged_papers) ? rec.merged_papers : [],
          query_status: status,
          query_model: safeText(rec.query_model),
          query_sections: safeText(rec.query_sections),
          query_sections_found: rec.query_sections_found || [],
          query_question: safeText(rec.query_question),
          query_response: safeText(rec.query_response),
          query_error: safeText(rec.query_error),
          total_tokens: totalTokens,
          prompt_tokens: Number(usage.prompt_tokens || 0),
          output_tokens: Number(usage.output_tokens || 0),
          query_elapsed_ms: elapsed,
          pdf_url: safeText(rec.pdf_url),
        };
      }

      function statusColor(status) {
        if (status === "ok") return "var(--ok)";
        if (status === "no_sections") return "var(--warn)";
        if (status === "error") return "var(--err)";
        return "var(--muted)";
      }

      function statusBadgeClass(status) {
        if (status === "ok") return "ok";
        if (status === "no_sections") return "warn";
        if (status === "error") return "err";
        return "";
      }

      function parseJSONL(text) {
        state.parseErrors = 0;
        const lines = text.split(/\r?\n/).filter((l) => l.trim().length > 0);
        const out = [];
        for (let i = 0; i < lines.length; i++) {
          try {
            out.push(normalizeRecord(JSON.parse(lines[i])));
          } catch (e) {
            state.parseErrors += 1;
          }
        }
        return out;
      }

      function buildStats(records) {
        const by = new Map();
        let totalTokens = 0;
        for (const r of records) {
          const k = r.query_status || "unknown";
          by.set(k, (by.get(k) || 0) + 1);
          totalTokens += r.total_tokens || 0;
        }
        const chips = [];
        chips.push({
          label: `显示 ${records.length}/${state.all.length}`,
          color: "var(--muted)",
        });
        chips.push({
          label: `总 tokens ${totalTokens.toLocaleString()}`,
          color: "var(--info)",
        });
        if (state.parseErrors) {
          chips.push({
            label: `解析失败 ${state.parseErrors}`,
            color: "var(--err)",
          });
        }
        for (const [k, v] of [...by.entries()].sort((a, b) =>
          a[0].localeCompare(b[0])
        )) {
          chips.push({
            label: `${k} ${v}`,
            color: statusColor(k),
          });
        }
        return chips;
      }

      function renderStats() {
        elStats.innerHTML = "";
        const chips = buildStats(state.filtered);
        for (const c of chips) {
          const span = document.createElement("span");
          span.className = "chip";
          const dot = document.createElement("span");
          dot.className = "dot";
          dot.style.background = c.color;
          span.appendChild(dot);
          const t = document.createElement("span");
          t.textContent = c.label;
          span.appendChild(t);
          elStats.appendChild(span);
        }
      }

      function renderStatusOptions() {
        const seen = new Set(state.all.map((r) => r.query_status || "unknown"));
        const options = [...seen].sort((a, b) => a.localeCompare(b));
        elStatus.innerHTML = '<option value="">全部</option>';
        for (const s of options) {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          elStatus.appendChild(opt);
        }
      }

      function renderList() {
        elList.innerHTML = "";
        if (!state.filtered.length) {
          elList.innerHTML = '<div class="hint">没有匹配的结果。</div>';
          return;
        }
        const frag = document.createDocumentFragment();

        const makeBadge = (text, cls) => {
          const span = document.createElement("span");
          span.className = `badge ${cls || ""}`.trim();
          span.textContent = text;
          return span;
        };

        for (const r of state.filtered) {
          const card = document.createElement("details");
          card.className = "paper";

          const summary = document.createElement("summary");

          const left = document.createElement("div");
          left.className = "head-left";

          const title = document.createElement("div");
          title.className = "title";
          title.textContent = r.title || "(Untitled)";

          const meta = document.createElement("div");
          meta.className = "meta";
          const metaParts = [];
          if (r.year) metaParts.push(r.year);
          if (r.venue) metaParts.push(r.venue);
          if (r.arxiv_id) metaParts.push(r.arxiv_id);
          meta.textContent = metaParts.join(" · ");

          left.appendChild(title);
          if (meta.textContent) left.appendChild(meta);

          const right = document.createElement("div");
          right.className = "badges";
          right.appendChild(makeBadge(r.query_status || "unknown", statusBadgeClass(r.query_status)));
          if (r.total_tokens) {
            right.appendChild(makeBadge(`tokens ${r.total_tokens.toLocaleString()}`));
          }
          if (r.query_elapsed_ms) {
            right.appendChild(makeBadge(`耗时 ${r.query_elapsed_ms.toLocaleString()}ms`));
          }
          if (r.query_model) {
            right.appendChild(makeBadge(r.query_model));
          }

          summary.appendChild(left);
          summary.appendChild(right);
          card.appendChild(summary);

          const body = document.createElement("div");
          body.className = "paper-body";

          const links = document.createElement("div");
          links.className = "meta";
          const arxivUrl = getArxivUrl(r.arxiv_id);
          if (arxivUrl) {
            const a = document.createElement("a");
            a.href = arxivUrl;
            a.target = "_blank";
            a.rel = "noreferrer";
            a.textContent = `打开 ${r.arxiv_id}`;
            links.appendChild(a);
          }
          if (r.pdf_url) {
            const a = document.createElement("a");
            a.href = r.pdf_url;
            a.target = "_blank";
            a.rel = "noreferrer";
            a.textContent = "PDF";
            links.appendChild(a);
          }
          if (links.childNodes.length) body.appendChild(links);

          const sectionInfo = document.createElement("div");
          sectionInfo.className = "meta";
          const found = Array.isArray(r.query_sections_found)
            ? r.query_sections_found.join(", ")
            : safeText(r.query_sections_found);
          const secParts = [];
          if (r.query_sections) secParts.push(`请求章节: ${r.query_sections}`);
          if (found) secParts.push(`找到章节: ${found}`);
          if (secParts.length) {
            sectionInfo.textContent = secParts.join(" · ");
            body.appendChild(sectionInfo);
          }

          if (Array.isArray(r.merged_papers) && r.merged_papers.length) {
            const merged = document.createElement("div");
            merged.className = "section";
            const mergedTitle = document.createElement("h3");
            mergedTitle.textContent = "本次查询包含论文";
            merged.appendChild(mergedTitle);
            const list = document.createElement("ul");
            list.className = "paper-list";
            for (const p of r.merged_papers) {
              const li = document.createElement("li");
              const parts = [];
              const titleText = safeText(p.title).trim();
              if (titleText) parts.push(titleText);
              const authorText = safeText(p.authors).trim();
              if (authorText) parts.push(authorText);
              const venueText = safeText(p.venue).trim();
              if (venueText) parts.push(venueText);
              li.textContent = parts.join(" · ");
              list.appendChild(li);
            }
            merged.appendChild(list);
            body.appendChild(merged);
          }

          const qDetails = document.createElement("details");
          qDetails.className = "question";
          const qSummary = document.createElement("summary");
          qSummary.textContent = "问题（点击展开）";
          qDetails.appendChild(qSummary);
          const qPre = document.createElement("pre");
          qPre.textContent = r.query_question || "(无 query_question)";
          qDetails.appendChild(qPre);
          body.appendChild(qDetails);

          const responseText =
            r.query_status === "ok"
              ? r.query_response
              : r.query_error || "(无错误信息)";

          const response = document.createElement("div");
          response.className = "section";
          const respTitle = document.createElement("h3");
          respTitle.textContent = "回答";
          const mdSwitch = document.createElement("div");
          mdSwitch.className = "md-switch";
          const btnRender = document.createElement("button");
          btnRender.type = "button";
          btnRender.className = "secondary active";
          btnRender.textContent = "渲染";
          const btnRaw = document.createElement("button");
          btnRaw.type = "button";
          btnRaw.className = "secondary";
          btnRaw.textContent = "原文";

          const respRender = document.createElement("div");
          respRender.className = "response markdown md-pane";
          respRender.innerHTML = renderMarkdown(responseText || "");

          const respRaw = document.createElement("pre");
          respRaw.className = "response md-pane hidden";
          respRaw.textContent = responseText || "";

          const setPane = (mode) => {
            const showRaw = mode === "raw";
            respRaw.classList.toggle("hidden", !showRaw);
            respRender.classList.toggle("hidden", showRaw);
            btnRaw.classList.toggle("active", showRaw);
            btnRender.classList.toggle("active", !showRaw);
          };
          btnRender.addEventListener("click", () => setPane("render"));
          btnRaw.addEventListener("click", () => setPane("raw"));

          mdSwitch.appendChild(btnRender);
          mdSwitch.appendChild(btnRaw);
          response.appendChild(respTitle);
          response.appendChild(mdSwitch);
          response.appendChild(respRender);
          response.appendChild(respRaw);
          body.appendChild(response);

          const actions = document.createElement("div");
          actions.className = "actions";

          const btnCopy = document.createElement("button");
          btnCopy.type = "button";
          btnCopy.className = "secondary";
          btnCopy.textContent = "复制内容";
          btnCopy.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(responseText || "");
              btnCopy.textContent = "已复制";
              setTimeout(() => (btnCopy.textContent = "复制内容"), 900);
            } catch {
              btnCopy.textContent = "复制失败";
              setTimeout(() => (btnCopy.textContent = "复制内容"), 900);
            }
          });
          actions.appendChild(btnCopy);

          const btnCopyPrompt = document.createElement("button");
          btnCopyPrompt.type = "button";
          btnCopyPrompt.className = "secondary";
          btnCopyPrompt.textContent = "复制问题";
          btnCopyPrompt.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(r.query_question || "");
              btnCopyPrompt.textContent = "已复制";
              setTimeout(() => (btnCopyPrompt.textContent = "复制问题"), 900);
            } catch {
              btnCopyPrompt.textContent = "复制失败";
              setTimeout(() => (btnCopyPrompt.textContent = "复制问题"), 900);
            }
          });
          actions.appendChild(btnCopyPrompt);

          body.appendChild(actions);
          card.appendChild(body);
          frag.appendChild(card);
        }

        elList.appendChild(frag);
      }

      function setAllDetails(openState) {
        const cards = elList.querySelectorAll("details.paper");
        cards.forEach((card) => {
          card.open = openState;
        });
      }

      function applyFilters() {
        const q = elQ.value.trim().toLowerCase();
        const st = elStatus.value;
        const out = [];
        for (const r of state.all) {
          if (st && r.query_status !== st) continue;
          if (q) {
            const hay =
              `${r.title}\n${r.arxiv_id}\n${r.query_response}\n${r.query_error}\n${JSON.stringify(r.merged_papers || [])}`.toLowerCase();
            if (!hay.includes(q)) continue;
          }
          out.push(r);
        }

        const sort = elSort.value;
        if (sort === "tokens_desc") {
          out.sort((a, b) => (b.total_tokens || 0) - (a.total_tokens || 0));
        } else if (sort === "elapsed_asc") {
          out.sort((a, b) => (a.query_elapsed_ms || 0) - (b.query_elapsed_ms || 0));
        } else if (sort === "title_asc") {
          out.sort((a, b) => a.title.localeCompare(b.title));
        }

        state.filtered = out;
        renderStats();
        renderList();
      }

      async function loadFromFile(file) {
        const text = await file.text();
        state.all = parseJSONL(text);
        state.filtered = [];
        renderStatusOptions();
        applyFilters();
        setLoadHint("当前加载：本地文件");
      }

      async function loadFromJob(jobId) {
        if (!jobId) return false;
        try {
          const resp = await fetch(`/data/${jobId}/papers.query.jsonl`, { cache: "no-store" });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const text = await resp.text();
          state.all = parseJSONL(text);
          state.filtered = [];
          state.activeJobId = jobId;
          renderStatusOptions();
          applyFilters();
          setLoadHint(`当前加载：${jobId}`);
          return true;
        } catch (e) {
          setLoadHint(`加载失败：${jobId}`);
          return false;
        }
      }

      async function tryLoadDefault() {
        const candidates = [
          "./store/query/comparison/papers.query.jsonl",
          "./store/query/papers.query.jsonl",
        ];
        for (const path of candidates) {
          try {
            const resp = await fetch(path, { cache: "no-store" });
            if (!resp.ok) continue;
            const text = await resp.text();
            state.all = parseJSONL(text);
            state.filtered = [];
            renderStatusOptions();
            applyFilters();
            setLoadHint(`当前加载：${path}`);
            return;
          } catch (e) {
            // ignore
          }
        }
        alert(
          "未能加载默认路径。请用右上角的“选择文件”加载 papers.query.jsonl。\\n\\n提示：如果你直接双击打开 HTML，浏览器可能限制 fetch 访问本地文件；建议运行：python -m http.server"
        );
      }

      function clearAll() {
        state.all = [];
        state.filtered = [];
        state.parseErrors = 0;
        state.activeJobId = null;
        elQ.value = "";
        elStatus.value = "";
        elList.innerHTML = "";
        elStats.innerHTML = "";
        elStatus.innerHTML = '<option value="">全部</option>';
        setLoadHint("已清空");
      }

      elFile.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        await loadFromFile(file);
      });
      elQ.addEventListener("input", () => applyFilters());
      elStatus.addEventListener("change", () => applyFilters());
      elSort.addEventListener("change", () => applyFilters());
      elLoadDefault.addEventListener("click", () => tryLoadDefault());
      elClear.addEventListener("click", () => clearAll());
      elExpandAll.addEventListener("click", () => setAllDetails(true));
      elCollapseAll.addEventListener("click", () => setAllDetails(false));

      async function fetchHistory() {
        try {
          const resp = await fetch("/history", { cache: "no-store" });
          if (!resp.ok) return null;
          const data = await resp.json();
          return Array.isArray(data.history) ? data.history : [];
        } catch {
          return null;
        }
      }

      async function postJson(path, payload) {
        const resp = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload || {}),
        });
        let data = {};
        try {
          data = await resp.json();
        } catch {
          data = {};
        }
        if (!resp.ok) {
          const msg = safeText(data.error) || `HTTP ${resp.status}`;
          throw new Error(msg);
        }
        return data;
      }

      function updateHistoryActionState() {
        const hasRealJob = !!safeText(elHistory.value).trim();
        const hasAnyRealJob = Array.from(elHistory.options || []).some(
          (opt) => !!safeText(opt.value).trim()
        );
        if (elDeleteHistory) {
          elDeleteHistory.disabled = !hasRealJob;
        }
        if (elClearHistoryAll) {
          elClearHistoryAll.disabled = !hasAnyRealJob;
        }
      }

      function formatHistoryLabel(item) {
        const ts = safeText(item.created_at);
        let stamp = ts;
        if (ts) {
          const d = new Date(ts);
          if (!Number.isNaN(d.getTime())) {
            stamp = d.toLocaleString();
          }
        }
        const query = safeText(item.query).trim();
        const count = item.item_count ? ` · ${item.item_count} 篇` : "";
        if (stamp && query) return `${stamp} · ${query}${count}`;
        if (query) return `${query}${count}`;
        return `${item.job_id || "(未知)"}${count}`;
      }

      async function refreshHistory(preselectJob) {
        const history = await fetchHistory();
        if (history === null) {
          elHistory.innerHTML = '<option value="">(未启用)</option>';
          updateHistoryActionState();
          return null;
        }
        elHistory.innerHTML = "";
        if (!history.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "(暂无历史)";
          elHistory.appendChild(opt);
          updateHistoryActionState();
          return history;
        }
        for (const item of history) {
          const opt = document.createElement("option");
          opt.value = item.job_id || "";
          opt.textContent = formatHistoryLabel(item);
          elHistory.appendChild(opt);
        }
        if (preselectJob && history.some((h) => h.job_id === preselectJob)) {
          elHistory.value = preselectJob;
        }
        updateHistoryActionState();
        return history;
      }

      elHistory.addEventListener("change", async () => {
        const job = elHistory.value;
        updateHistoryActionState();
        if (!job) return;
        await loadFromJob(job);
      });

      elRefreshHistory.addEventListener("click", async () => {
        const current = elHistory.value;
        const history = await refreshHistory(current || undefined);
        if (history && history.length && !elHistory.value) {
          elHistory.value = history[0].job_id;
        }
        updateHistoryActionState();
      });

      elDeleteHistory.addEventListener("click", async () => {
        const job = safeText(elHistory.value).trim();
        if (!job) return;
        const ok = window.confirm(`确认删除历史记录 ${job} 吗？`);
        if (!ok) return;
        try {
          const data = await postJson("/history/delete", { job_id: job });
          if (!data.deleted) {
            alert("未删除：记录不存在或已被清理。");
          }
          if (state.activeJobId === job) {
            clearAll();
          }
          const history = await refreshHistory();
          if (history && history.length) {
            const latest = safeText(history[0].job_id).trim();
            if (latest) {
              elHistory.value = latest;
              await loadFromJob(latest);
            }
          } else {
            setLoadHint("历史记录已删除。");
          }
        } catch (e) {
          alert(`删除失败：${e.message || e}`);
        } finally {
          updateHistoryActionState();
        }
      });

      elClearHistoryAll.addEventListener("click", async () => {
        const ok = window.confirm("确认清空所有历史记录吗？该操作不可撤销。");
        if (!ok) return;
        try {
          const data = await postJson("/history/clear", {});
          clearAll();
          await refreshHistory();
          setLoadHint(`已清空历史记录（删除 ${Number(data.removed || 0)} 条）`);
        } catch (e) {
          alert(`清空失败：${e.message || e}`);
        } finally {
          updateHistoryActionState();
        }
      });

      async function initPage() {
        const params = new URLSearchParams(window.location.search);
        const jobParam = params.get("job");
        const history = await refreshHistory(jobParam || undefined);
        if (jobParam) {
          const ok = await loadFromJob(jobParam);
          if (ok) return;
        }
        if (history && history.length) {
          const latest = history[0].job_id;
          if (latest) {
            elHistory.value = latest;
            await loadFromJob(latest);
            return;
          }
        }
        if (history === null) {
          await tryLoadDefault();
        } else {
          setLoadHint("暂无历史查询，请等待服务写入结果或手动选择文件。");
        }
      }

      initPage();
    </script>
  </body>
</html>
